<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="liaohuming.com"><title>Windows系统下采用命令行编译C++ MPI程序 | Keep getting better</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Windows系统下采用命令行编译C++ MPI程序</h1><a id="logo" href="/.">Keep getting better</a><p class="description">好记性不如烂笔头</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 简历</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Windows系统下采用命令行编译C++ MPI程序</h1><div class="post-meta">Feb 22, 2020<span> | </span><span class="category"><a href="/categories/笔记/">笔记</a></span></div><a class="disqus-comment-count" data-disqus-identifier="2020/02/22/notes/20200222-Windows系统下采用命令行编译C++ MPI程序/" href="/2020/02/22/notes/20200222-Windows系统下采用命令行编译C++ MPI程序/#disqus_thread"></a><div class="post-content"><h3 id="一-目的"><a href="#一-目的" class="headerlink" title="一. 目的"></a>一. 目的</h3><p>目标程序比较大，之前主要是在Liunx下进行程序的开发、编译与使用，现在想在Windows下进行开发、编译与使用。为了实现跨平台，程序的编译过程不宜采用Visual Studio IDE建立的Solution进行编译，否则更换编译器时，VS的Soultion就用不了了。</p>
<p>理想的方式是自己编写程序编译的脚本文件，采用命令行编译的方式，程序使用的开发语言是C++，并采用MPI进行并行化。为此，本文记录如何在Windows系统下采用命令行编译C++ MPI程序。</p>
<h3 id="二-C-编译过程"><a href="#二-C-编译过程" class="headerlink" title="二. C++ 编译过程"></a>二. <a href="https://blog.csdn.net/leonliu06/article/details/78229534" target="_blank" rel="noopener">C++ 编译过程</a></h3><p>一般而言，对于 C++ 程序编译有以下4个阶段：</p>
<p><strong>预处理（preprocessing）</strong><br>对源程序中的伪指令（以#开头的指令）和特殊符号进行处理。伪指令包括宏定义、条件编译指令、头文件包含指令等。</p>
<p><strong>编译（compilation）</strong><br>将预处理后的文件编译生成后缀为.s的汇编语言文件，。编译程序所要做的工作是通过记法分析和语法分析，在确认所有指令都符合语法规则后，将其翻译成等价的中间代码或汇编代码。</p>
<p><strong>汇编（assembly）</strong><br>将汇编文件汇编生成后缀为.o的目标文件（二进制）。汇编过程实际上是指把汇编语言代码翻译成目标机器指令的过程。</p>
<p><strong>链接（linking）</strong><br>将多个目标文件和库连接生成后缀为.out或.exe的可执行文件。链接程序的主要工作就是将有关的目标文件彼此相连接，即将在一个文件中引用的符号现该符号在另外一个文件中的定义连接起来，使得所有的这些目标文件成为一个能够被操作系统装入执行的统一整体。</p>
<p><strong>链接处理</strong><br>静态链接（static linking）:指链接器在链接时将库（静态库）的内容拷贝到可执行程序中。<br>动态链接（dynamic linking）:指程序运行时才将库（动态链接库）连接到程序中。</p>
<h3 id="三-环境"><a href="#三-环境" class="headerlink" title="三. 环境"></a>三. 环境</h3><ol>
<li>Windows 10 操作系统</li>
<li>安装Visual Studio Professional 2017</li>
<li>安装MSMPI，安装路径为：<code>D:\Program Files (x86)</code></li>
<li>目标程序版本：x64</li>
</ol>
<h3 id="四-编译方法"><a href="#四-编译方法" class="headerlink" title="四. 编译方法"></a>四. 编译方法</h3><ol>
<li>方法一：Visual Studio Professional 2017 IDE环境下的编译，详见<a href="https://blog.csdn.net/hsajas/article/details/80103414" target="_blank" rel="noopener">VS2017配置MPI</a>文章介绍</li>
<li>方法二：命令行编译C++ MPI程序。参考：<a href="https://stackoverflow.com/questions/50195657/how-to-compile-and-run-c-c-mpi-codes-in-cmd-on-windows-without-visual-studio" target="_blank" rel="noopener">How to compile and run C/C++ MPI codes in cmd on windows without Visual Studio</a></li>
</ol>
<p>具体步骤为：</p>
<ol>
<li><p>建立一个简单的mpi c++代码，如：MpiHelloWorld.cpp，并保存，例如：E:\Desktop\MPI_Test\MpiHelloWorld.cpp，接下来就采用命令行对此源代码进行编译</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include<span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#include<span class="meta-string">&lt;mpi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="keyword">int</span> myid, numprocs;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MPI_Init</span>(&amp;argc, &amp;argv);</span><br><span class="line">    <span class="built_in">MPI_Comm_rank</span>(<span class="built_in">MPI_COMM_WORLD</span>, &amp;myid);</span><br><span class="line">    <span class="built_in">MPI_Comm_size</span>(<span class="built_in">MPI_COMM_WORLD</span>, &amp;numprocs);</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">"%d Hello world from process %d \n"</span>, numprocs, myid);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MPI_Finalize</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开开始菜单中的<code>x64 Native Tools Command Prompt for VS 2017</code>工具，用vs自带的命令行工具，可以方便地调用cl.exe和link.exe，如果不想用vs自带的命令行工具，也可以使用windows原始的cmd命令行工具，不过这种情况下需要自己手动定义好vs的引用目录和库文件目录的环境变量。此处采用的是vs提供的命令行工具。<br><img src="/img/20200222-1.jpg" alt=""></p>
</li>
<li><p>切换至MpiHelloWorld.cpp文件所在目录</p>
</li>
</ol>
<p>首先编译，在该目录下执行以下命令：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cl -I"D:<span class="symbol">\P</span>rogram Files (x86)<span class="symbol">\M</span>icrosoft SDKs<span class="symbol">\M</span>PI<span class="symbol">\I</span>nclude" -I"D:<span class="symbol">\P</span>rogram Files (x86)<span class="symbol">\M</span>icrosoft SDKs<span class="symbol">\M</span>PI<span class="symbol">\I</span>nclude<span class="symbol">\x</span>64" -c MPIHelloWorld.cpp</span><br></pre></td></tr></table></figure></p>
<p>其中，cl为cl.exe编译器，-I（大写的i）表示指定第一个寻找头文件的目录（如果指定多个目录，则使用多个-I），在本例中要将MPI的两个Include目录包含进去。-c表示只编译不链接。编译完之后可以看到当前目录下生成了MPIHelloWorld.obj汇编文件<br><img src="/img/20200222-2.jpg" alt=""></p>
<p>然后链接，在该目录下执行以下命令：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">link</span> <span class="selector-tag">-machine</span><span class="selector-pseudo">:x64</span> <span class="selector-tag">-out</span><span class="selector-pseudo">:MpiHelloWorld.exe</span> <span class="selector-tag">-dynamicbase</span> "<span class="selector-tag">msmpi</span><span class="selector-class">.lib</span>" <span class="selector-tag">-libpath</span><span class="selector-pseudo">:"D</span>:\<span class="selector-tag">Program</span> <span class="selector-tag">Files</span> (<span class="selector-tag">x86</span>)\<span class="selector-tag">Microsoft</span> <span class="selector-tag">SDKs</span>\<span class="selector-tag">MPI</span>\<span class="selector-tag">Lib</span>\<span class="selector-tag">x64</span>" <span class="selector-tag">MPIHelloWorld</span><span class="selector-class">.obj</span></span><br></pre></td></tr></table></figure></p>
<p>其中，link为link.exe链接器，-machine:x64表示x64版本，-out表示指定输出文件名，-dynamicbase表示包含附加依赖项msmpi.lib，而-libpath表示设置库目录，最后MPIHelloWorld.obj表示要链接的汇编文件。链接完之后可以看到当前目录下生成了MPIHelloWorld.exe可执行文件<br><img src="/img/20200222-3.jpg" alt=""></p>
<p>最后，执行该程序，例如本例中采用10个核<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mpiexec</span> <span class="selector-tag">-n</span> 10 <span class="selector-tag">MPIHelloWorld</span><span class="selector-class">.exe</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/20200222-4.jpg" alt=""></p>
<p>至此，完成了Windows系统下采用命令行编译C++ MPI程序，参考此编译过程，可以将其应用到复杂的程序编译过程中，此是后话了。</p>
</div><div class="tags"><a href="/tags/C/">C++</a></div><div class="post-nav"><a class="pre" href="/2020/02/23/notes/20200223-Latex测试/">Latex测试</a><a class="next" href="/2018/03/06/diary/20180306-大道平直努力向前/">大道平直，努力向前</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'liaohuming';
var disqus_identifier = '2020/02/22/notes/20200222-Windows系统下采用命令行编译C++ MPI程序/';
var disqus_title = 'Windows系统下采用命令行编译C++ MPI程序';
var disqus_url = 'http://liaohuming.com/2020/02/22/notes/20200222-Windows系统下采用命令行编译C++ MPI程序/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//liaohuming.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/23/notes/20200223-Latex测试/">Latex测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/22/notes/20200222-Windows系统下采用命令行编译C++ MPI程序/">Windows系统下采用命令行编译C++ MPI程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/06/diary/20180306-大道平直努力向前/">大道平直，努力向前</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/19/notes/20170419-编程过程中的小错误/">编程过程中的小错误</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/02/notes/20160902-Linux常用命令备忘（持续更新）/">Linux常用命令备忘（持续更新）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/22/notes/20160822-Linux下批量运行测试算例的简单实现（二）/">Linux下批量运行测试算例的简单实现（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/18/diary/20160818-最近/">最近</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/01/diary/20160501-我们都需要改变/">我们都需要改变</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/31/notes/20160331-多思考，勤笔记/">多思考，勤笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/notes/20160218-Windows与Linux两种格式文件相互转化问题的简单解决方案/">Windows与Linux两种格式文件相互转化问题的简单解决方案</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//liaohuming.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://liaohuqiu.net/" title="Srain" target="_blank">Srain</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Keep getting better.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>